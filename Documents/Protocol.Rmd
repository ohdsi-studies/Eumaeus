---
title: "| RESEARCH PROTOCOL (DRAFT)\n| \n| EUMAEUS: Evaluating Use of Methods for Adverse Event Under Surveillance (for vaccines)\n"
fontsize: 12pt
geometry: margin=1in
output:
  bookdown::html_document2:
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float: yes
    number_sections: yes
    number_tables: yes
    css: "style.css"
  bookdown::pdf_document2:
    keep_tex: yes
    latex_engine: xelatex
    md_extensions: +raw_attribute
    number_sections: yes
    # citation_package: natbib
    includes:
      before_body: title.tex
  bookdown::word_document2:
    toc: yes
    reference_docx: "template.docx"
header-includes:
- \usepackage[numbers,sort&compress]{natbib}
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{caption}
- \usepackage{rotating}
- \usepackage{multirow}
- \usepackage{mwe,tikz}
- \usepackage[percent]{overpic}
- \usepackage{enumitem}
- \usepackage{hyperref}
- \newcolumntype{P}[1]{>{\raggedright\arraybackslash}p{#1}}
- \newcommand{\footerDate}{`r params$date`}
- \input{header.tex}
longtable: yes
mainfont: Arial
bibliography: Protocol.bib
params:
  date: '2023-11-06'
  version: 2.0.0
subtitle: 'Version: `r params$version`'
link-citations: true
csl: jamia.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.pos = "H")
options(kableExtra.latex.load_packages = FALSE)
library(kableExtra)
#knitr::knit_hooks$set(document = function(x) {sub('\\usepackage[]{color}', '\\usepackage[table]{xcolor}', x, fixed = TRUE)})
library(dplyr)
options(knitr.kable.NA = "")
if (!knitr::is_latex_output() && !knitr::is_html_output()) {
  options(knitr.table.format = "simple")
}

# pdf2png <- function(path) {
#   # only do the conversion for non-LaTeX output
#   if (knitr::is_latex_output()) {
#     return(path)
#   }
#   path2 <- xfun::with_ext(path, "png")
#   img <- magick::image_read_pdf(path)
#   magick::image_write(img, path2, format = "png")
#   path2
# }


latex_table_font_size <- 8

source("PrintCohortDefinitions.R")

numberOfNcs <- nrow(readr::read_csv("../inst/settings/NegativeControls.csv", col_types = readr::cols()))

```

# List of Abbreviations

```{r abbreviations, echo=FALSE, results="asis", warning=FALSE}
abbreviations <- readr::read_delim(col_names = FALSE, delim = ";", trim_ws = TRUE, file = "
  AUC; Area Under the receiver-operator Curve 
  CCAE; IBM MarketScan Commercial Claims and Encounters 
  CDM; Common Data Model
  CIOMS; Council for International Organizations of Medical Sciences
  COVID-19; COronaVIrus Disease 2019
  CPRD; Clinical Practice Research Datalink
  CRAN; Comprehensive R Archive Network
  EHR; Electronic Health Record
  EMA; European Medicines Agency
  ENCEPP; European Network of Centres for Pharmacoepidemiology and Pharmacovigilance
  H1N1pdm; Hemagglutinin Type 1 and Neuraminidase Type 1 (2009 pandemic influenza)
  HPV; Human PapillomaVirus
  IRB; Institutional review board
  JMDC; Japan Medical Data Center
  LLR; Log Likelihood Ratio
  MDCR; IBM MarketScan Medicare Supplemental Database
  MDCD; IBM MarketScan Multi-State Medicaid Database 
  MSE; Mean Squared Error
  OHDSI; Observational Health Data Science and Informatics
  OMOP; Observational Medical Outcomes Partnership
  MaxSPRT; MAXimized Sequential Probability Ratio Test 
  PS; Propensity score
  RCT; Randomized controlled trial
  SCCS; Self-Controlled Case Series
  SCRI; Self-Controlled Risk Interval
  WHO; World Health Organization
")

tab <- kable(abbreviations, col.names = NULL, linesep = "", booktabs = TRUE)

if (knitr::is_latex_output()) {
  tab %>% kable_styling(latex_options = "striped", font_size = latex_table_font_size) %>%
    kable_styling(latex_options = "HOLD_position")
} else {
  tab %>% kable_styling(bootstrap_options = "striped")
} 
```

# Responsible Parties

## Investigators

```{r parties, echo=FALSE, results="asis", warning=FALSE}
parties <- readr::read_delim(col_names = TRUE, delim = ";", trim_ws = TRUE, file = "
  Version 2.0 Investigator; Institution/Affiliation
  Fan Bu; Department of Biostatistics, University of Michigan, Ann Arbor, MI, USA
  Shounak Chattopadhyay; Department of Biostatistics, University of California, Los Angeles, Los Angeles, CA, USA  
  George Hripcsak; Department of Biomedical Informatics, Columbia University, New York, NY, USA
  Patrick B. Ryan; Observational Health Data Analytics, Janssen Research and Development, Titusville, NJ, USA
  Martijn J. Schuemie; Observational Health Data Analytics, Janssen Research and Development, Titusville, NJ, USA
  Marc A. Suchard *; Department of Biostatistics, University of California, Los Angeles, Los Angeles, CA, USA
")

# <!-- CHANGE Added new authors -->

tab <- kable(parties, booktabs = TRUE, linesep = "") %>% 
  column_spec(1, width = "10em") %>%
  column_spec(2, width = "30em") %>%
  footnote(general = "* Principal Investigator", general_title = "")

if (knitr::is_latex_output()) {
  tab %>% kable_styling(latex_options = "striped", font_size = latex_table_font_size) %>%
    kable_styling(latex_options = "HOLD_position")
} else {
  tab %>% kable_styling(bootstrap_options = "striped")
}
```

## Disclosures

This study is undertaken within Observational Health Data Sciences and Informatics (OHDSI), an open collaboration.
**GH** receives grant funding from the US National Institutes of Health and the US Food & Drug Administration.
**PBR** and **MJS** are employees of Janssen Research and Development and shareholders in John & Johnson.
**MAS** receives grant funding from the US National Institutes of Health and the US Food & Drug Administration and contracts from the US Department of Veterans Affairs and Janssen Research and Development.

# Abstract

**Background and Significance**

As recently approved COVID-19 vaccines are rolled out globally, it is likely that safety signals will be identified from spontaneous reports and other data sources. Although some work has been done on the best methods for vaccine safety surveillance, there is a scarcity of information on how these perform in analyses of real-world data.

**Study Aims**

To study the comparative performance (bias, precision, and timeliness) of different analytical methods for the study of comparative vaccine safety.

**Study Description**

* Design: Cohort, self-controlled, and case-control studies 
* Exposures: previous viral vaccines including 2017-2018 flu, H1N1pdm flu, Human Papillomavirus (HPV) and Varicella-Zoster, and BNT162b2 and mRNA-1273 mRNA vaccines against COVID-19.
* Outcomes: selected adverse events of special interest (e.g., myocarditis or pericarditis); negative control outcomes; imputed positive control outcomes
* Analyses: 
    1) Historical rate comparisons. 
    2) Cohort analyses using a contemporary non-user comparator, with large-scale propensity score matching
    3) Self-controlled case series with variations
    4) Case-control analyses
    5) Concurrent comparator
* Metrics:
    - Area Under the receiver-operator Curve (AUC). The ability to discriminate between positive controls and negative controls based on the point estimate of the effect size. Will be stratified by true effect size of the positive controls.
    - Coverage. How often the true effect size is within the 95% confidence interval.
    - Mean precision, computed as 1 / (standard error)2
    - Mean squared error (MSE). Mean squared error between the log of the effect size point-estimate and the log of the true effect size.
    - Type 1 error. For negative controls, how often was the null rejected (at alpha = 0.05). This is equivalent to the false positive rate and 1 - specificity.
    - Type 2 error. For positive controls, how often was the null not rejected (at alpha = 0.05). This is equivalent to the false negative rate and 1 - sensitivity. Will be stratified by true effect size of the positive controls.
    - Non-estimable. Measure for how many of the controls was the method unable to produce an estimate
    - Sensitivity and specificity based on the MaxSPRT decision rule
    - Detection time: the number of months until 80% of positive controls exceeds the critical value. Will be stratified by true effect size of the positive controls.

# Amendments and Updates

Table \@ref(tab:amendments) lists any protocol amendments made over time.

```{r amendments, echo=FALSE, results="asis", warning=FALSE}
amendments <- readr::read_delim(col_names = TRUE, delim = ";", trim_ws = TRUE, file = "
  Number; Date; Section of study protocol; Amendment or update; Reason
  1.1.0;2021-04-09;Methods to evaluate;Added historic comparator, cohort method, and SCCS variations;The historic comparator variation was based on initial EMAEUS results showing (preventable) outliers. The cohort method and SCCS variants are based on 3rd-party protocols for COVID-19 vaccine safety surveillance.
  1.2.0;2021-06-29;Exposure-outcome pairs;Switched from synthetic to imputed positive controls;Positive control synthesis requires a minimum number of outcomes in the data, precluding many negative controls and leading to only ‘highly’ powered positive controls. This limited the ability to measure performance of methods in low-power settings. Positive control imputation is more simplistic but can be applied in low-power settings.
  2.0.0;2023-11-06; Abstract; Added BNT162b2 and mRNA-1273 vaccines and concurrent comparator design; Second EUMAEUS study (EUMAEUS v2) to evaluate concurrent comparator design using negative and imputed positive control outcomes and myocarditis or pericarditisis real-world positive control outcome.
  2.0.0;2023-11-06; Investigators; Updated authors; EUMAEUS v2
  2.0.0;2023-11-06; Milestones; Added new milestone dates; EUMAEUS v2
  2.0.0;2023-11-06; Exposure-outcome pairs; Added BNT1262b2 and mRNA-1273 COVID-19 vaccines; EUMAEUS v2
  2.0.0;2023-11-06; Real-world positive control outcome; Added myocarditisis or pericarditisis for COVID-19 vaccines; EUMAEUS v2
  2.0.0;2023-11-06; Methods to evaluation; Added concurrent comparator with three target/comparator design choices; EUMAEUS v2
  2.0.0;2023-11-06; Time-at-risk; Added concurrent comparator time-at-risk definitions for consistency with method use-cases and EUMAEUS v1 choices; EUMAEUS v2
  2.0.0;2023-11-06; Exposure cohort definitions; Added BNT162b2 and mRNA-1273 COVID-19 vaccine cohort definitions; EUMAEUS v2
  2.0.0;2023-11-06; Real-world outcome cohort definition; Added myocarditis or pericarditis outcome cohort defintion; EUMAEUS v2
  2.0.0;2024-01-30; Overview of analyses; Updated total number of estimates to include real-world positive control outcome; EUMAEUS v2
  2.0.0;2024-01-30; Appendix; Corrected age restriction for BNT162b2 and EUA date for mRNA-1273; EUMAEUS v2
")

# <!-- TODO All amendments -->

tab <- kable(amendments, booktabs = TRUE, linesep = "", caption = "Protocol amendments")

if (knitr::is_latex_output()) {
  tab %>%
    column_spec(1, width = "4em") %>%
    column_spec(2, width = "6em") %>%
    column_spec(3, width = "10em") %>%
    column_spec(4, width = "15em") %>%
    column_spec(5, width = "15em") %>%
    kable_styling(latex_options = "striped", font_size = latex_table_font_size) %>%
    kable_styling(latex_options = "HOLD_position")

} else {
  tab %>% kable_styling(bootstrap_options = "striped")
}
```

# Milestones

Table \@ref(tab:dates) lists the study milestones.

```{r dates, echo=FALSE, results="asis", warning=FALSE}
dates <- readr::read_delim(col_names = TRUE, delim = ";", trim_ws = TRUE, file = "
  Milestone; Planned / actual date
  EU PAS Registration;2021-03-23 / 2021-03-23
  Start of analysis;2021-03-23 / 2021-03-25
  End of analysis;2021-05-01 / 2021-05-31
  Results presentation;2021-05-01 / 2021-06-29
  Start of 2nd analysis; 2024-02-12
  End of 2nd analysis; 2024-04-23
  Results presentation; 2024-05-21
")

tab <- kable(dates, booktabs = TRUE, linesep = "", caption = "Study milestones") 

if (knitr::is_latex_output()) {
  tab %>% kable_styling(latex_options = "striped", font_size = latex_table_font_size) %>%
    kable_styling(latex_options = "HOLD_position")
} else {
  tab %>% kable_styling(bootstrap_options = "striped")
}
```

# Rationale and Background

A total of 3 COVID-19 vaccines have been approved for clinical use in Europe, and 3 in the USA.
Many more are in pipeline, and at least two more have reported to date on phase 3 efficacy data. Although safe and effective based on large randomised controlled trials, COVID-19 vaccines will be subject to post-marketing safety studies, including both analyses of spontaneous reports (pharmacovigilance) as well as longitudinal analyses in the form of post-authorisation safety studies.  

The ENCEPP (European Network of Centres for Pharmacoepidemiology and Pharmacovigilance) methodological guidelines, in their 8th revision,[@encepp2010] mention a few documents that set out standards for the conducting of vaccine safety studies. 
Specific aspects related to vaccine safety research are discussed in detail in different materials, including the Report of the CIOMS/WHO Working Group on Definition and Application of Terms for Vaccine Pharmacovigilance (2012), the CIOMS Guide to Active Vaccine Safety Surveillance (2017), the CIOMS Guide to Vaccine Safety Communication (2018), the Brighton Collaboration resources, the Module 4 (Surveillance) of the e-learning training course Vaccine Safety Basics by the World Health Organization (WHO), or the recommendations on vaccine-specific aspects of the EU pharmacovigilance system outlined in the Module P.I: Vaccines for prophylaxis against infectious diseases of the Good pharmacovigilance practices (GVP). 
Additionally, the Accelerated Development of VAccine beNefit-risk Collaboration in Europe (ADVANCE) project has summarized methods for vaccine safety in a bespoke report [@advance2014] covering multiple study designs, both experimental and observational in nature. 
The EMA (European Medicines Agency) has also issued guidances [@ema2020_1] and a plan [@ema2020_2] for pharmacovigilance of COVID-19 vaccines. 
Despite this plethora of literature and guidance, there is a scarcity of methodological studies on the performance of different methods for vaccine safety. 

Given the quick and increasingly global rollout of COVID-19 vaccines internationally, it is highly likely that potential safety signals will emerge, which will need a timely but robust evaluation in ‘real world’ observational studies. 
It is therefore urgent that we conduct large-scale evaluations of methods for vaccine safety, similar to previous work on methods for drug safety. [@Schuemie2020-he]
The results of this evaluation will help us understand how these methods will perform when applied to COVID-19 vaccines. 

# Study Objectives

The overarching aim is to identify the best methods for the generation of evidence of vaccine safety in observational, real-world data.
Specific aims:

- To estimate the bias and precision associated with the use of different methods (historic rate, cohort, self-controlled, and case-control) for the study of vaccine safety compared
- To compare the 'timeliness' of these methods for the identification of vaccine safety signals

# Research Methods

## Exposure-outcome pairs

### Exposures

The evaluation will center on six existing (groups of) vaccines, for specific time periods (start date to end date), as shown in Table \@ref(tab:exposures-of-interest).


```{r exposures-of-interest, echo=FALSE, warning=FALSE}
eois <- readr::read_csv(system.file("settings", "ExposuresOfInterest.csv", package = "Eumaeus"), col_types = readr::cols()) %>%
  select(exposureName, startDate, endDate, historyStartDate, historyEndDate)
colnames(eois) <- SqlRender::camelCaseToTitleCase(colnames(eois))

tab <- eois %>%
  kable(booktabs = TRUE, linesep = "",
      caption = "Exposures of interest.") %>% 
  kable_styling(bootstrap_options = "striped", latex_options = "striped")

if (knitr::is_latex_output()) {
  tab %>%
    column_spec(1, width = "18em") %>%
    column_spec(2, width = "8em") %>%
    column_spec(3, width = "8em") %>%
    column_spec(4, width = "8em") %>%
    column_spec(5, width = "8em") %>%
    kable_styling(font_size = latex_table_font_size) %>%
    kable_styling(latex_options = "HOLD_position")
} else {
  tab
}
```

For some methods the period between historic start and historic end date will be used to estimate the historic incidence rate. 
For analyses executed on data in the southern hemisphere (if any) the flu seasons are different, and the study periods will need to be adjusted accordingly.
The formal cohort definitions of each exposure can be found in Appendix \@ref(exposure-cohort-definitions). 

### Negative control outcomes 

Negative controls are outcomes believed not to be caused by any of the vaccines, and therefore ideally would not be flagged as a signal by a safety surveillance system. 
Any effect size estimates for negative control ideally should be close to the null. 

A single set of negative control outcomes is defined for all six vaccine groups.
To identify negative control outcomes that match the severity and prevalence of suspected vaccine adverse effects, a candidate list of negative controls was generated based on similarity of prevalence and percent of diagnoses that were recorded in an inpatient setting (as a proxy for severity). 
Manual review of this list by clinical experts created the final list of `r numberOfNcs` negative control outcomes. 
The full list of negative control outcomes can be found in Appendix \@ref(negative-controls)

Negative control outcomes are defined as the first occurrence of the negative control concept or any of its descendants. 

### Imputed positive control outcomes 

Positive controls are outcomes known to be caused by vaccines, and ideally would be detected as signals by a safety surveillance system as early as possible.
For various reasons, real positive controls are problematic.[@Schuemie2018-zi] 
Instead, here we will rely on imputed positive controls, created by shifting the estimated effect sizes for the negative controls. 
We assume the negative controls have a true effect size of 1, so to simulate the estimated effect size when the true effect size is $\theta$ we multiply the estimate by $\theta$. 
For example, if for a negative control a method produces an effect size estimate of 1.1, for a positive control with true effect size of 2 the estimated effect size becomes 1.1 x 2 = 2.2. 
This approach makes strong assumptions on the nature of the systematic error, most importantly that systematic error does not change as a function of the true effect size. 
Although this assumption is likely not to hold in the real world, imputing positive controls allows us to provide some indication of what type 2 error to expect for various true effect sizes. 
For each negative control we will impute positive controls with true effect sizes of 1.5, 2, and 4, so using the `r numberOfNcs` negative controls we are able to construct `r numberOfNcs` $\times$ 3 = `r numberOfNcs*3` positive control outcomes.
This increased true effect is applied both for the first and second injection of multi-dose vaccines.

### Real-world positive control outcome for COVID-19 vaccines

In addition to the negative control and imputed positive control outcomes, we will further investigate the risk of myocarditis or pericarditis following COVID-19 vaccination as a real-world positive control outcome [@Wong2022-qt,@Goddard2022-uk].
Lee et al. used a historical comparator design and demonstrated an increased risk after vaccination across several administrative claims data sources.
Goddard et al. used a concurrent comparator design and found an elevated risk ratio 0 - 7 days post vaccination of 3.3 (95% confidence interval, 1.5 - 7.0) summing across both BNT162b2 and mRNA-1273 vaccines.
We will use this positive control to evaluate each method's detection statistical performance and timeliness to detect an increased association.
Our cohort definition (see Appendix) for myocarditis or pericarditis was developed and validated across 26 data sources [@Li2021-yw,@Voss2023-nc]


## Data sources

We will execute EUMAEUS as an OHDSI network study.
All data partners within OHDSI are encouraged to participate voluntarily and can do so conveniently, because of the community's shared Observational Medical Outcomes Partnership (OMOP) common data model (CDM) and OHDSI tool-stack.
Many OHDSI community data partners have already committed to participate and we will recruit further data partners through OHDSI’s standard recruitment process, which includes protocol publication on OHDSI’s GitHub, an announcement in OHDSI’s research forum, presentation at the weekly OHDSI all-hands-on meeting and direct requests to data holders.

Table \@ref(tab:data-sources) lists the 5 already committed data sources for EUMAEUS; these sources encompass a large variety of practice types and populations. 
For each data source, we report a brief description and size of the population it represents.
All data sources will receive institutional review board approval or exemption for their participation before executing EUMAEUS.

```{r data-sources, echo=FALSE, warning=FALSE}
data_sources <- readr::read_delim(col_names = TRUE, delim = ";", trim_ws = TRUE, file = "
  Data source ; Population ; Patients ; History ; Data capture process and short description
  IBM MarketScan Commercial Claims and Encounters (CCAE) ; Commercially insured, < 65 years ; 142M ; 2000 -- ; Adjudicated health insurance claims (e.g. inpatient, outpatient, and outpatient pharmacy)  from large employers and health plans who provide private healthcare coverage to employees, their spouses and dependents.
  IBM MarketScan Medicare Supplemental Database (MDCR)  ; Commercially insured, 65+ years ; 10M ; 2000 -- ; Adjudicated health insurance claims of retirees with primary or Medicare supplemental coverage through privately insured fee-for-service, point-of-service or capitated health plans.
  IBM MarketScan Multi-State Medicaid Database (MDCD) ; Medicaid enrollees, racially diverse ; 26M ; 2006 -- ; Adjudicated health insurance claims for Medicaid enrollees from multiple states and includes hospital discharge diagnoses, outpatient diagnoses and procedures, and outpatient pharmacy claims.
  Optum Clinformatics Data Mart (Optum) ; Commercially or Medicare insured ; 85M ; 2000 -- ; Inpatient and outpatient healthcare insurance claims.
  Optum Electronic Health Records (OptumEHR) ; US, general ; 93M ; 2006 -- ; Clinical information, prescriptions, lab results, vital signs, body measurements, diagnoses and procedures derived from clinical notes using natural language processing. 
")
tab <- kable(data_sources, booktabs = TRUE, linesep = "",
      caption = "Committed EUMAEUS data sources and the populations they cover.") %>% 
  kable_styling(bootstrap_options = "striped", latex_options = "striped") %>%
  pack_rows("Administrative claims", 1, 4, latex_align = "c", indent = FALSE) %>%
  pack_rows("Electronic health records (EHRs)", 5, 5, latex_align = "c", indent = FALSE)

if (knitr::is_latex_output()) {
  tab %>%
    column_spec(1, width = "10em") %>%
    column_spec(2, width = "10em") %>%
    column_spec(5, width = "25em") %>%
    kable_styling(font_size = latex_table_font_size) %>%
    kable_styling(latex_options = "HOLD_position")
} else {
  tab
}
```

## Methods to evaluate

Vaccine safety surveillance methods can be broken down in to four components: construction of a *counterfactual* (often referred to as the 'expected count'), a *time-at-risk*, the *statistic* to estimate, and potentially a *decision rule* on the estimate to classify signals from non-signals.

### Counterfactual construction

**Historic rates**

Traditionally, vaccine surveillance methods compute an expected count based an incidence rate estimated during some historic time period, for example in the years prior to the initiation of the surveillance study. We will use the historic period indicated in Table \@ref(tab:exposures-of-interest). 
We will evaluate two variations:

- Unadjusted, entire year. Using a single rate computed across the entire historic year for the entire population.
- Age and sex adjusted, entire year. Using a rate stratifying by age (in 10 year increments) and sex, computed across the entire historic year. This allows the expected rate to be adjusted for the demographics of the vaccinated.
- Unadjusted, time-at-risk relative to outpatient visit. Using a single rate computed during the time-at-risk relative to a random outpatient visit in the historic year.
- Age and sex adjusted, time-at-risk relative to outpatient visit. Using a rate stratifying by age and sex, computed during the time-at-risk relative to a random outpatient visit in the historic year. 

Initial results show that this counterfactual approach is sensitive to changes in coding practices. 
We therefore introduce a study diagnostic: the percent change in overall incidence rate (across the entire population) between the historic and current time period. 
For each of the four variations listed above, we add a new variation where effect-size estimates are removed if the change in incidence rate is greater than 50%.

**Cohort method using a contemporary non-user comparator**

A comparator cohort study most closely emulates a randomized clinical trial, comparing the target cohort (those vaccinated) to some comparator cohort.
We define two types of non-user comparator cohort, one having an outpatient visit on the index date, and another having a random date as the index date.
For both comparator variants we exclude subjects having a vaccinations for the same disease as the target vaccine on or before the index date.
When doing unadjusted comparisons, the comparator cohort will be a random sample of equal size as the target cohort.
When doing propensity score (PS) adjusted comparisons, the comparator cohort will be a stratified (by age and sex) random sample of four times the size of the target cohort (two times for the Seasonal Flu Vaccination (all) target cohort for computational reasons).
Propensity models will use a large generic set of covariates, including demographics and covariates per drug, condition, procedure, measurement, etc., and will be fitted using large-scale regularized regression as described previously. [@Tian2018-xy]
We will evaluate 10 method variations:

Anchoring the comparator on a random outpatient visit:

- Unadjusted comparison.
- 1-on-1 PS matching.
- PS stratification. Five equally-sized strata will be defined in the target (vaccinated) population.
- Inverse Probability of Treatment Weighting (IPTW). We will use stabilized weights to compute the average treatment effect in the treated (ATT). Weights will be truncated to a maximum value of 10, similar to Izurieta et al. (2020). [@Izurieta2020]
- 1-on-1 PS matching within each period, using only the 'new' data in that period to fit the propensity model. Once a population is matched in a period, that matching will be carried forward to subsequent periods. This method will only be evaluated using the H1N1pdm vaccinations for computational reasons.

Anchoring the comparator on a random date:

- Unadjusted comparison.
- 1-on-1 PS matching.
- PS stratification.
- IPTW with trimming.
- 1-on-1 PS matching within each period. This method will only be evaluated using the H1N1pdm vaccinations for computational reasons.

**Self-Controlled Case Series (SCCS) / Self-Controlled Risk Interval (SCRI)**

The SCCS and SCRI designs are self-controlled, comparing the time-at-risk (the time shortly following the vaccination) to some other time in the same patient's record. 
The SCCS design uses all patient time when not at risk as the control time. [@Whitaker2006]
The SCRI design uses a pre-specified control interval relative to the vaccination date as the control time. [@glanz2011]
This unexposed time can be both before or after the time at risk.
We will evaluate five variations:

- A simple SCCS, using all patient time when not at risk as the control time, with the exception of the 30 days prior to vaccination which is excluded from the analysis to avoid bias due to contra-indications.
- An SCCS adjusting for age and season. Age and season will be modeled to be constant within each calendar month, and vary across months as bicubic splines.
- A simple SCCS discarding all time prior to vaccination.
- An SCRI, using a control interval of 43 to 15 days prior to vaccination.
- An SCRI, using a control interval of 43 to 71 days after to vaccination.

**Case-control**

The case-control design compares cases (those with the outcome) to controls (those that do not have the outcome), and looks back in time for exposures to a vaccine. 
We will evaluate two variants:

- Using up to four age and sex matched controls per case. For age we will use a two-year caliper.
- By sampling controls from the general non-case population, and adjusting for age and sex in the outcome model. The control sample will be four times the number of controls. Age will be modeled as one variable per 5-year age category.

**Concurrent comparator**

Risk of confounding and biased estimation due to differences between patients who choose to receive a vaccine or when they choose to obtain the vaccine remain.  
The concurrent comparator method aims to control for this bias by predefining a risk interval and designating patients in the exposure target cohort as vaccinated patients who were more recently vaccinated at the time of observation and patients in the control group as vaccinated comparators who had been vaccinated at an earlier time [@Klein2021-kx].
We will evaluate three variants that cover two different uses of the concurrent comparator method in the literature [@Klein2021-kx,@Goddard2022-uk] and have a time-at-risk equal to our prior methods comparison [@Schuemie2022-wj]:

- Using target patients who had been vaccinated 0-7 days prior as compared to comparator patients on the same day who had been vaccinated 22-42 days
- Target: 1-21 days vs comparator: 22-42 days
- Target: 1-28 days vs comparator: 29-56 days

### Time-at-risk

The time-at-risk is the time window, relative to the vaccination date, when outcomes will potentially be attributed to the vaccine.
We define three time-at-risk windows: 1-28 days, 1-42 days, and 0-1 days after vaccination for the historical rates, cohort, SCCS and case-control methods.
For the concurrent comparator method we define 0-7 days, 1-21 days and 1-28 days time-at-risk windows for greater comparability with the literature.
Time-at-risk windows will be constructed both for the first and second dose.
The time-at-risk for one dose will be censored at the time of the next dose.

### Statistic

- Effect-size estimate. Each method can be used to produce an effect-size estimates such as a hazard ratio, incidence rate ratio, or odds ratio. For example, when using a historic rate we can compute the observed to expected ratio, which can be interpreted as the incidence rate ratio.

- Log likelihood ratio (LLR). A common practice in vaccine safety surveillance is to computer the LLR, which is the log of the ratio between the likelihood of the alternative hypothesis (that there is an effect) and the likelihood of the null hypothesis (of no effect). 
The LLR is a convenient statistic when performing sequential testing, where the LLR can be compared to a pre-computed critical value, as is done in the MaxSPRT method. [@kulldorf2011] 
Although typically MaxSPRT uses a historic rate as counterfactual, any counterfactual can be used to compute the LLR and can be used in MaxSPRT.

Effect-size estimates will be computed both with and without empirical calibration. [@Schuemie2014-bv;@Schuemie2018-hq]
Empirical calibration will be done using leave-one-out: when calibrating the estimate for a control, the systematic error distribution will be fitted uses all controls except the one being calibrated.

### Decision rule

To identify 'signals' we need a decision rule, for example in the shape of a threshold value on one of the estimates statistics.
In our experiment we will consider one decision rule, which is the critical value computed for the LLR at an alpha of 0.05. 
For the historical rates method we will use a Poisson model assuming the counterfactual is known without uncertainty.
For all other methods we will use a binomial model. 
All critical values will be computed using the [`Sequential` package in CRAN](https://cran.r-project.org/web/packages/Sequential/index.html).

## Metrics

Similar to our previous study, we will compute the following metrics based on the effect size estimates: [@Schuemie2020-wx]

- Area Under the receiver-operator Curve (AUC). The ability to discriminate between positive controls and negative controls based on the point estimate of the effect size. This will be stratified by true effect size of the positive controls.
- Coverage. How often the true effect size is within the 95% confidence interval.
- Mean precision. Precision is computed as 1 / (standard error)2, higher precision means narrower confidence intervals. We use the geometric mean to account for the skewed distribution of the precision.
- Mean squared error (MSE). Mean squared error between the log of the effect size point-estimate and the log of the true effect size.
- Type 1 error. For negative controls, how often was the null rejected (at alpha = 0.05). This is equivalent to the false positive rate and 1 - specificity.
- Type 2 error. For positive controls, how often was the null not rejected (at alpha = 0.05). This is equivalent to the false negative rate and 1 - sensitivity. This will be stratified by true effect size of the positive controls.
- Non-estimable. For how many of the controls was the method unable to produce an estimate? There can be various reasons why an estimate cannot be produced, for example because there were no subjects left after propensity score matching, or because no subjects remained having the outcome.

In addition, based on the MaxSPRT decision rule, we will compute sensitivity, specificity, as well as the number of months until 80% of all positive controls exceeds the critical value (detection time). 
These will be stratified by true effect size of the positive controls.

### Timeliness

To understand the time it takes for a method the identify signals, the study period for each vaccine will be divided into calendar months. 
For each month the methods will be executed using the data that had accumulated up to the end of that month, and the performance metrics will be reported for each month.

### Multiple doses

For the zoster and HPV vaccines requiring multiple doses separated by multiple months, metrics will be computed three times: 

- Treating all doses the same, so computing statistics using both doses without distinguishing between first and second.
- Using the first dose only
- Using the second dose only

## Overview of analyses

In total, we will evaluate:

- 14 counterfactuals
- 3 times at risk (0-1, 1-28 and 1-42 days, or 0-7, 1-21, 1-28 days for the concurrent comparator)
- 6 vaccines, with a total of 9 + 9 + 9 + 9 + 12 + 12 = 60 time periods
- `r numberOfNcs` negative controls
- 3 $\times$ `r numberOfNcs` = `r 3*numberOfNcs` synthetic positive controls
- 1 real-world positive control outcome
- 3 dose definitions (both, first, second) for the zoster and HPV vaccines, 1 for H1N1pdm, seasonal flu, the two COVID-19 vaccines

Resulting in a total of 14 $\times$ 3 $\times$ [(9 + 9 + 9 + 9) $\times$ 1 + (12 + 12) $\times$ 3]  $\times$ (`r numberOfNcs` + `r numberOfNcs*3` + 1) = `r format(14 * 3 * ((9 + 9 + 9 + 9) * 1 + (12 + 12) * 3) * numberOfNcs * (numberOfNcs*3+1), scientific = FALSE, big.mark = ",")` effect-size estimates. Each estimate will contain:

- The effect-size estimate (e.g. hazard ratio, incidence rate ratio, odds ratio) with 95% confidence interval and p-value.
- The empirically calibrated effect-size estimate and p-value
- The LLR

This will be computed for each database.

# Strengths and Limitations

## Strengths
- Cohort studies allow direct estimation of incidence rates following exposure of interest, and the new-user design can capture early events following treatment exposures while avoiding confounding from previous treatment effects; new use allows for a clear exposure index date.
- Large-scale propensity score matching and stratification create balance on a large number of baseline potential confounders and have been found in the past to balance unmeasured confounders.
- Systematic processes including a pre-specified selection of covariates avoids investigator-specific biases in variable selection.
- Use of real negative and imputed positive control outcomes provides an independent estimate of residual bias in the experiment.
- The fully specified study protocol is being published before analysis begins.
- Dissemination of the results will not depend on estimated effects, avoiding publication bias.
- All analytic methods have previously been verified on real data.
- All software is freely available as open source.
- Use of a common data model allows extension of the experiment to future databases and allows replication of these results on licensable databases that were used in this experiment, while still maintaining patient privacy on patient-level data.
- Use of multiple databases allows estimating consistency to add credibility and supports generalizability.

 
## Limitations
 
- Even though many potential confounders will be included in this study, there may be residual bias due to unmeasured or misspecified confounders, such as confounding by indication, differences in physician characteristics that may be associated with drug choice, concomitant use of other drugs started after the index date, and informative censoring at the end of the on-treatment periods. To minimize this risk, we used methods to detect residual bias through our negative and positive controls.
- Our follow-up times are limited and variable, potentially reducing power to detect differences in effectiveness and safety.
- We assume hazards are not time varying.
- Misclassification of study variables is unavoidable in secondary use of health data, so it is possible to misclassify treatments, covariates, and outcomes; we do not expect differential misclassification, so bias will most likely be towards the null.
- The electronic health record databases may be missing care episodes for patients due to care outside the respective health systems; bias will most likely be towards the null.

# Protection of Human Subjects

EUMAEUS does not involve human subjects research.
The project does, however, use de-identified human data collected during routine healthcare provision.
All data partners executing the EUMAEUS studies within their data sources will have received institutional review board (IRB) approval or waiver for participation in accordance to their institutional governance prior to execution (see Table \@ref(tab:irb)).
EUMAEUS executes across a federated and distributed data network, where analysis code is sent to participating data partners and only aggregate summary statistics are returned, with no sharing of patient-level data between organizations.

```{r irb, echo=FALSE,warning=FALSE}
data_sources <- readr::read_delim(col_names = TRUE, delim = "&", trim_ws = TRUE, file = "
Data source & Statement
IBM MarketScan Commercial Claims and Encounters (CCAE) & New England Institutional Review Board and was determined to be exempt from broad IRB approval, as this research project did not involve human subject research.
IBM MarketScan Medicare Supplemental Database (MDCR)  & New England Institutional Review Board and was determined to be exempt from broad IRB approval, as this research project did not involve human subject research.
IBM MarketScan Multi-State Medicaid Database (MDCD) & New England Institutional Review Board and was determined to be exempt from broad IRB approval, as this research project did not involve human subject research.
Optum Clinformatics Data Mart (Optum) & New England Institutional Review Board and was determined to be exempt from broad IRB approval, as this research project did not involve human subject research.
Optum Electronic Health Records (OptumEHR) & New England Institutional Review Board and was determined to be exempt from broad IRB approval, as this research project did not involve human subject research.
")

tab <- kable(data_sources, booktabs = TRUE, linesep = "",
      caption = "IRB approval or waiver statement from partners.") %>% 
  kable_styling(bootstrap_options = "striped", latex_options = "striped")

if (knitr::is_latex_output()) {
  tab %>%
    column_spec(1, width = "15em") %>%
    column_spec(2, width = "40em") %>%
    kable_styling(font_size = latex_table_font_size) %>%
    kable_styling(latex_options = "HOLD_position")
} else {
  tab
}
```

# Management and Reporting of Adverse Events and Adverse Reactions

EUMAEUS uses coded data that already exist in electronic databases.
In these types of databases, it is not possible to link (i.e., identify a potential causal association between) a particular product and medical event for any specific individual.
Thus, the minimum criteria for reporting an adverse event (i.e., identifiable patient, identifiable reporter, a suspect product and event) are not available and adverse events are not reportable as individual adverse event reports.
The study results will be assessed for medically important findings.

# Plans for Disseminating and Communicating Study Results

Open science aims to make scientific research, including its data process and software, and its dissemination, through publication and presentation, accessible to all levels of an inquiring society, amateur or professional [@Woelfle2011-ss] and is a governing principle of EUMAEUS.
Open science delivers reproducible, transparent and reliable evidence.
All aspects of EUMAEUS (except private patient data) will be open and we will actively encourage other interested researchers, clinicians and patients to participate.
This differs fundamentally from traditional studies that rarely open their analytic tools or share all result artifacts, and inform the community about hard-to-verify conclusions at completion.

## Transparent and re-usable research tools

We will publicly register this protocol and announce its availability for feedback from stakeholders, the OHDSI community and within clinical professional societies.
This protocol will link to open source code for all steps to generating diagnostics, effect estimates, figures and tables.
Such transparency is possible because we will construct our studies on top of the OHDSI toolstack of open source software tools that are community developed and rigorously tested [@Schuemie2020-wx].
We will publicly host EUMAEUS source code at (https://github.com/ohdsi-studies/Eumaeus), allowing public contribution and review, and free re-use for anyone’s future research.

## Continous sharing of results

EUMAEUS embodies a new approach to generating evidence from healthcare data that overcome weaknesses in the current process of answering and publishing (or not) one question at a time.
Generating evidence for thousands of research and control questions using a systematic process enables us to not only evaluate that process and the coherence and consistency of the evidence, but also to avoid $p$-hacking and publication bias [@Schuemie2018-zi].
We will store and openly communicate all of these results as they become available using a user-friendly web-based app that serves up all descriptive statistics, study diagnostics and effect estimates for each cohort comparison and outcome.
Open access to this app will be through a general public facing EUMAEUS web-page.

## Scientific meetings and publications

We will deliver multiple presentations at scientific venues and will also prepare multiple scientific publications for clinical, informatics and statistical journals.

## General public

We believe in sharing our findings that will guide clinical care with the general public.
EUMAEUS will use social-media (Twitter) to facilitate this.
With dedicated support from the OHDSI communications specialist, we will deliver regular press releases at key project stages, distributed via the extensive media networks of UCLA and Columbia.

# References {-}

<div id="refs"></div>

# (APPENDIX) Appendix {-}

# Exposure Cohort Definitions

```{r h1n1-cohort, echo=FALSE, results="asis", warning=FALSE, message=FALSE}
baseCohortJson <- SqlRender::readSql(system.file("cohorts", "H1N1vaccination.json", package = "Eumaeus"))
baseCohort <- RJSONIO::fromJSON(baseCohortJson)

baseCohortJson <- RJSONIO::toJSON(baseCohort, digits = 50)

printCohortDefinitionFromNameAndJson(name = "H1N1pdm Vaccines",
                                     json = baseCohortJson)
```

```{r fluvirin-cohort, echo=FALSE, results="asis", warning=FALSE, message=FALSE}
baseCohortJson <- SqlRender::readSql(system.file("cohorts", "Fluvirin.json", package = "Eumaeus"))
baseCohort <- RJSONIO::fromJSON(baseCohortJson)

baseCohortJson <- RJSONIO::toJSON(baseCohort, digits = 50)

printCohortDefinitionFromNameAndJson(name = "Seasonal Flu Vaccines (Fluvirin)",
                                     json = baseCohortJson)
```

```{r fluzone-cohort, echo=FALSE, results="asis", warning=FALSE, message=FALSE}
baseCohortJson <- SqlRender::readSql(system.file("cohorts", "Fluzone.json", package = "Eumaeus"))
baseCohort <- RJSONIO::fromJSON(baseCohortJson)

baseCohortJson <- RJSONIO::toJSON(baseCohort, digits = 50)

printCohortDefinitionFromNameAndJson(name = "Seasonal Flu Vaccines (Fluzone)",
                                     json = baseCohortJson)
```

```{r flu-cohort, echo=FALSE, results="asis", warning=FALSE, message=FALSE}
baseCohortJson <- SqlRender::readSql(system.file("cohorts", "AllFluVaccines.json", package = "Eumaeus"))
baseCohort <- RJSONIO::fromJSON(baseCohortJson)

baseCohortJson <- RJSONIO::toJSON(baseCohort, digits = 50)

printCohortDefinitionFromNameAndJson(name = "Seasonal Flu Vaccines (All)",
                                     json = baseCohortJson)
```

```{r hpv-cohort, echo=FALSE, results="asis", warning=FALSE, message=FALSE}
baseCohortJson <- SqlRender::readSql(system.file("cohorts", "Gardasil9.json", package = "Eumaeus"))
baseCohort <- RJSONIO::fromJSON(baseCohortJson)

baseCohortJson <- RJSONIO::toJSON(baseCohort, digits = 50)

printCohortDefinitionFromNameAndJson(name = "HPV Vaccines",
                                     json = baseCohortJson)
```

```{r zoster-cohort, echo=FALSE, results="asis", warning=FALSE, message=FALSE}
baseCohortJson <- SqlRender::readSql(system.file("cohorts", "Shingrix.json", package = "Eumaeus"))
baseCohort <- RJSONIO::fromJSON(baseCohortJson)

baseCohortJson <- RJSONIO::toJSON(baseCohort, digits = 50)

printCohortDefinitionFromNameAndJson(name = "Zoster Vaccines",
                                     json = baseCohortJson)
```

```{r comirnaty-cohort, echo=FALSE, results="asis", warning=FALSE, message=FALSE}
baseCohortJson <- SqlRender::readSql(system.file("cohorts", "ComirnatyCovid19.json", package = "Eumaeus"))
baseCohort <- RJSONIO::fromJSON(baseCohortJson)

baseCohortJson <- RJSONIO::toJSON(baseCohort, digits = 50)

printCohortDefinitionFromNameAndJson(name = "COVID-19 mRNA vaccine (BNT162b2)",
                                     json = baseCohortJson)
```

```{r spikevax-cohort, echo=FALSE, results="asis", warning=FALSE, message=FALSE}
baseCohortJson <- SqlRender::readSql(system.file("cohorts", "SpikevaxCovid19.json", package = "Eumaeus"))
baseCohort <- RJSONIO::fromJSON(baseCohortJson)

baseCohortJson <- RJSONIO::toJSON(baseCohort, digits = 50)

printCohortDefinitionFromNameAndJson(name = "COVID-19 mRNA vaccine (mRNA-1273)",
                                     json = baseCohortJson)
```

# Real-world outcome cohort definition for COVID-19 vaccines

```{r guillainBarre-cohort, echo=FALSE, results="asis", warning=FALSE, message=FALSE}
baseCohortJson <- SqlRender::readSql(system.file("cohorts", "MyocarditisPericarditis.json", package = "Eumaeus"))
baseCohort <- RJSONIO::fromJSON(baseCohortJson)

baseCohortJson <- RJSONIO::toJSON(baseCohort, digits = 50)

printCohortDefinitionFromNameAndJson(name = "Adverse event outcome - myocarditis or pericarditis",
                                     json = baseCohortJson)
```

# Negative controls

```{r ncs, echo=FALSE, warning=FALSE}
ncs <- readr::read_csv(system.file("settings", "NegativeControls.csv", package = "Eumaeus"), col_types = readr::cols())
colnames(ncs) <- SqlRender::camelCaseToTitleCase(colnames(ncs))

tab <- kable(ncs, booktabs = TRUE, linesep = "",
      caption = "Negative control outcomes.", longtable = TRUE) %>% 
  kable_styling(bootstrap_options = "striped", latex_options = "striped")

if (knitr::is_latex_output()) {
  tab %>%
    column_spec(1, width = "15em") %>%
    column_spec(2, width = "40em") %>%
    kable_styling(font_size = latex_table_font_size) %>%
    kable_styling(latex_options = "HOLD_position")
} else {
  tab
}
```
